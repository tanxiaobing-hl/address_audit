from __future__ import annotations
from pathlib import Path

from address_audit.config import load_config
from address_audit.db import connect, init_db, clear_table, upsert_record, upsert_road, upsert_poi, upsert_anchor, insert_pair_labels
from address_audit.simulate import seed_base_entities, generate_address_records

"""
è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªåœ°å€ç¨½æ ¸ç³»ç»Ÿï¼ˆAddress Audit Systemï¼‰çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼Œç”¨äºä¸ºå¼€å?æµ‹è¯•ç¯å¢ƒå¿«é€Ÿæ­å»ºåŒ…å«çœŸå®æ„Ÿåœ°å€æ•°æ®çš?SQLite æ•°æ®åº“ã€?1. é…ç½®åŠ è½½
ä»?config.default.json åŠ è½½æ•°æ®åº“è·¯å¾„ç­‰é…ç½®,ç¡®å®šæ•°æ®å­˜å‚¨ä½ç½®

2. æ•°æ®åº“åˆå§‹åŒ–
è¿æ¥ SQLite å¹¶åˆ›å»ºè¡¨ç»“æ„ï¼ˆinit_dbï¼?å»ºç«‹ address_recordsã€roadsã€pois ç­‰å¿…è¦è¡¨

3. æ¸…ç©ºæ—§æ•°æ?æ¸…ç©º 9 ä¸ªç›¸å…³è¡¨ï¼ˆå«åœ°å€è®°å½•ã€è§£æç»“æœã€æ ‡ç­¾ç­‰ï¼?ä¿è¯åˆå§‹åŒ–ç¯å¢ƒå¹²å‡€ï¼Œé¿å…å†å²æ•°æ®å¹²æ‰?
4. æ³¨å…¥åœ°ç†å‚è€ƒæ•°æ?å°?seed_base_entities() ç”Ÿæˆçš„é“è·¯ã€POIã€é”šç‚¹å†™å…¥æ•°æ®åº“ï¼Œæ„å»ºåœ°å€è§£ææ‰€éœ€çš„â€œçŸ¥è¯†åº“â€ï¼ˆå¦‚â€œåˆ›æ–°å¤§é“â€â€œé«˜æ–°åˆ›æ–°å›­â€ç­‰ï¼?
5. ç”Ÿæˆåˆæˆåœ°å€
è°ƒç”¨ generate_address_records(30, 5) ç”Ÿæˆ 150 æ¡åœ°å€è®°å½•ï¼?0 ä¸ªå®ä½?Ã— 5 ç§å˜ä½“ï¼‰ï¼Œæ¨¡æ‹Ÿå¤šæºå¼‚æ„åœ°å€æ•°æ®ï¼ˆå¦‚é«˜å¾·ã€CRMã€äººå·¥å½•å…¥ç­‰ä¸åŒè¡¨è¾¾ï¼?
6. æ³¨å…¥ç›‘ç£æ ‡ç­¾
å°†åœ°å€é…å¯¹æ ‡ç­¾ï¼ˆæ­£æ ·æœ¬=åŒä¸€å®ä½“ï¼Œè´Ÿæ ·æœ¬=ä¸åŒå®ä½“ï¼‰å†™å…?pair_labelsï¼Œä¸ºåç»­è®­ç»ƒ/è¯„ä¼°åœ°å€å®ä½“æ¶ˆæ­§æ¨¡å‹æä¾›ç›‘ç£ä¿¡å·

7. è¾“å‡ºç»Ÿè®¡
æ‰“å°è®°å½•æ•°ã€æ ‡ç­¾æ•°åŠä¸‹ä¸€æ­¥æ“ä½œæç¤ºï¼Œä¾¿äºå¼€å‘è€…ç¡®è®¤åˆå§‹åŒ–ç»“æœ
"""

def main():
    root = Path(__file__).resolve().parent
    data_dir = root / "data"
    cfg = load_config(data_dir / "config.default.json")

    conn = connect(cfg.db_path)
    init_db(conn)

    for t in ["address_records","parsed_addresses","roads","pois","anchors","conflicts","match_logs","clusters","pair_labels"]:
        clear_table(conn, t)

    base = seed_base_entities()
    for r in base["roads"]:
        upsert_road(conn, r["road_id"], r["name"], r.get("district"), r.get("aliases", []))
    for p in base["pois"]:
        upsert_poi(conn, p["poi_id"], p["name"], p.get("poi_type"), p.get("district"), p["lat"], p["lon"], p.get("aliases", []))
    for a in base["anchors"]:
        upsert_anchor(conn, a["anchor_id"], a.get("anchor_type"), a["key_text"], a.get("district"), a["lat"], a["lon"])

    records, labels = generate_address_records(n_entities=30, variants_per_entity=5, seed=7)
    for rec in records:
        upsert_record(conn, rec)
    insert_pair_labels(conn, labels)

    print(f"DB initialized at: {cfg.db_path}")
    print(f"Inserted records: {len(records)}")
    print(f"Inserted pair labels: {len(labels)}")
    print("Next: python cli_run")

if __name__ == "__main__":
    main()

